.. |GB| replace:: *GeoBatch*
.. |GS| replace:: *GeoServer*
.. |GBCD| replace:: **GB conf dir**
.. |GBTD| replace:: **GB tmp dir**

.. _`datadir`:

Geobatch Configuration and Temp Directories
======================================

|GB| uses two important directories to store configurations and temporary files called 

* **GeoBatch configuration directory** reported later as |GBCD|
* **GeoBatch temporary directory** reported later as |GBTD|

Although |GB| provides a default management of these directories their management should be manually handled when configuring a production environment.

A custom |GB| directories configuration simplify system updates, backups and in general the maintenance of the system.


The GeoBatch configuration directory
-----------------------------------------

The |GBCD| is the file system location where |GB| stores its **configuration resources**. Some resources **can be stored only** in the |GBCD|, some other resources are stored there **by default** but can be moved outside if needed and others are stored there by default but it is considered a **best practices move them outside**. In the next paragraphs will be listed all the resources and will be explained wich are the best configurations to do. 

Setting the Configuration Directory location
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,

By default the |GBCD| is located inside the WEB-INF directory of the GeoBatch webapp and it is called ``data``. This location will be reported later as ``$gbwebinf`` on unix examples or ``%gbwebinf%`` on windows examples. Similar convenction also for tomcat bin directory ( ``$tomcatbin`` ``%tomcatbin%``)

Keep the datadir inside the |GB| deployment is a worst practice because when an application upgrade or an application redeploy is needed all the user custom configuration will be lost. With an external config dir the admin is free to redeploy the wep application: all the custom settings are stored in an external location.

The first thing to do is move that directory from there to another FileSystem location. A |GBCD| can be also created from scratch but is suggested to copy the default one to avoid configuration errors.

As example the target location where datadir will be copied, is:

``/var/configurations/geobatch`` on linux or

``c:\\configurations\\geobatch`` on windows.

So copy the directory ``$gbwebinf/data`` into ``/var/configurations/geobatch`` and be sure that the tomcat user has the R/W permission on that.

Linux example:

assuming that linux user running tomcat is called *tomcat* and belong to *tomcat* group; tomcat is turned off. All these command are performed with root grants (logged in as root or eventually through sudo on debian-like distributions)::

	$~root# mv $gbwebinf/data /var/configurations/geobatch    #move the internal datadir to an external location
	$~root# chown -R tomcat:tomcat /var/configurations/geobatch/data    #assign owner to data dir
	$~root# chmod -R 775 /var/configurations/geobatch/data    #assign W/R/X to *tomcat user* and *tomcat group*, R/X to others
	$~root# nano $tomcatbin/setenv.sh    #set the |GBCD| pointing to an external location: open setenv.sh in an editor then save the changes done. (The file is created if soesn't exist)
	
		JAVA_OPTS="-DGEOBATCH_CONFIG_DIR=/var/configurations/geobatch/data"
		
	
Windows example:
	
Perform step 1 with GUI copy&paste commands and open with notepad the setenv.bat file located in %tomcatbin% dir. Create it if doesn't exist. Add the following command (or append just the GEOBATCH_CONFIG_DIR variable if JAVA_OPTS already exist)

		set JAVA_OPTS=-DGEOBATCH_CONFIG_DIR=c:\\configurations\\geobatch\\data

Note that the JAVA_OPTS variable should contains also some other java settings variables, both on linux and windows of course, see the :ref:`jtweeks` section.


Configuration directory structure
.................................

In this section is reported a detailed description of all resources.

* ``catalog.xml``

This file is Mandatory and isn't created automatically at |GB| startup. You have to create it if you don't use an existing |GBCD| as the internal one. The location is the |GBCD| root and can't be customized.

Below there is a basic example:

.. code-block:: xml

	<?xml version="1.0" encoding="UTF-8"?>
	<CatalogConfiguration>
		<id>catalog</id>
		<description>descriptionFileBasedCatalogConfiguration</description>
		<name>nameFileBasedCatalogConfiguration</name>
	</CatalogConfiguration>

* ``*.xml`` files representing Flow configurations. They must be placed here, a flow exist (an can be displayed on GB GUI) only if its related configuration has been placed here. See :ref:`flwCnfg`
	
* ``settings`` directory, if doesn't exist this directory is autogenerated at startup. the next three resources are located inside the settings directory

* ``FLOW.xml`` General flow properties. The location of this file is inside the ``settings`` directory and can't be customized.

* ``JAI.xml`` General JAI settings. The location of this file is inside the ``settings`` directory and can't be customized.

* ``database`` this is the default location where the user database is created. See :ref:`databases`.

* ``temp`` dir, unless explicitly specified otherwise this directory is autogenerated at startup. see next section `The temporary directory`_

* Action configuration directories, following the hierarchy explained below, unless specified otherwise in the configuration file.

Each action needs a configuration dir. Its default location is ``GEOBATCH_CONFIG_DIR/FLOW_ID/ACTION_ID``. Custom locations can be specified inside the flow configuration files:

* At **flow level**, using the ``<overrideConfigDir>`` element. It will point to the directory containing all the configuration directories for all the actions in the flow. If the path specified in ``<overrideConfigDir>`` is relative, it will be placed under ``GEOBATCH_CONFIG_DIR``.

* At **action level**. Each action may override its own config dir location, using the ``<overrideConfigDir>`` element. If a relative path is given, it will be placed under its flow-level dir specification.

The temporary directory
-----------------------

The place where |GB| Actions will create their temporary files during execution, if not specified otherwise, will be under ``temp`` dir within ``GEOBATCH_CONFIG_DIR``.

The ``GEOBATCH_TEMP_DIR`` environment/system variable can be used to specify another location, the same way as ``GEOBATCH_CONFIG_DIR``.

.. note:: Make sure that |GB| (the running tomcat user) will have write permisions into the temporary directory.

What is the |GBTD|
,,,,,,,,,,,,,,,,,,,,,,,

Each Action instance needs to use a separate subdirectory under the base temp dir. The |GB| Engine will manage its creation, as explained below. In case an Action is instantiated manually and not through |GB| Engine, you will need to manage the subdirectory creation manually.

Subdirectory creation under ``GEOBATCH_CONFIG_DIR`` is automatically managed by |GB|, according to this pattern:

* Each flow wil have a separate temp dir for all of its running instances (the ``flowTempDir``):

  * By default this directory is called like the flow ID and is located under ``GEOBATCH_TEMP_DIR``.
  * Can be overridden in the FlowConfiguration, either as an absolute dir or as a relative one. In the latter case, it will be located under ``GEOBATCH_TEMP_DIR``.

* Every running instance of a flow has its own temp dir (the ``flowInstanceTempDir``):

  * By default, the name of this dir is built using the timestamp of its instantiation, and is placed inside its related ``flowTempDir``.

* Finally, every Action inside a running flow instance will have its own temp dir:

  * By default, the dir name is built using the Action ordinal position in the flow, and its ID (e.g. ``1_tiffRetile``), and is placed inside its related ``flowInstanceTempDir``.
